<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ –ö–µ–π—Å—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .balance-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .balance-amount {
            font-size: 2em;
            font-weight: bold;
            color: #FFD700;
        }
        
        .cases-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .case-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .case-card:hover {
            transform: translateY(-5px);
        }
        
        .case-emoji {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .case-price {
            font-size: 1.2em;
            color: #FFD700;
            font-weight: bold;
        }
        
        .inventory-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .item-emoji {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        .item-info {
            flex-grow: 1;
            text-align: left;
        }
        
        .item-count {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        
        .rarity-common { border-color: #808080; }
        .rarity-rare { border-color: #0070dd; }
        .rarity-epic { border-color: #a335ee; }
        .rarity-legendary { border-color: #ff8000; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid;
            max-width: 300px;
            width: 90%;
            animation: pulse 0.5s ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .reward-emoji {
            font-size: 4em;
            margin: 20px 0;
        }
        
        .reward-name {
            font-size: 1.5em;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .reward-rarity {
            font-size: 1.2em;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .button {
            background: #FFD700;
            color: #333;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: transform 0.2s ease;
        }
        
        .button:hover {
            transform: scale(1.05);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid red;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ –ö–µ–π—Å—ã</h1>
            <p>–û—Ç–∫—Ä—ã–≤–∞–π –∫–µ–π—Å—ã –∏ –ø–æ–ª—É—á–∞–π –ø—Ä–µ–¥–º–µ—Ç—ã!</p>
        </div>
        
        <div class="balance-card">
            <div>–¢–≤–æ–π –±–∞–ª–∞–Ω—Å</div>
            <div class="balance-amount" id="balance">0</div>
            <div>–º–æ–Ω–µ—Ç</div>
        </div>
        
        <div class="cases-grid" id="casesGrid">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–µ–π—Å–æ–≤...</div>
        </div>
        
        <div class="inventory-section">
            <h3>üì¶ –ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
            <div id="inventory">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è...</div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="rewardModal">
        <div class="modal-content">
            <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
            <div class="reward-emoji" id="rewardEmoji"></div>
            <div class="reward-name" id="rewardName"></div>
            <div class="reward-rarity" id="rewardRarity"></div>
            <div style="margin: 15px 0;">–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: <span id="newBalance"></span> –º–æ–Ω–µ—Ç</div>
            <button class="button" onclick="closeReward()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // Telegram Web App API
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        let userData = {};
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserData() {
            showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
            
            const data = {
                action: 'get_user_data'
            };
            
            tg.sendData(JSON.stringify(data));
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞
        function openCase(caseId) {
            showLoading('–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–µ–π—Å...');
            
            const data = {
                action: 'open_case',
                case_id: caseId
            };
            
            tg.sendData(JSON.stringify(data));
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function showLoading(message) {
            document.getElementById('casesGrid').innerHTML = `<div class="loading">${message}</div>`;
            document.getElementById('inventory').innerHTML = `<div class="loading">${message}</div>`;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
            document.getElementById('balance').textContent = userData.balance;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ–π—Å—ã
            const casesGrid = document.getElementById('casesGrid');
            casesGrid.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º –∫–µ–π—Å—ã
            const cases = [
                {
                    id: 1,
                    name: "üì¶ –û–±—ã—á–Ω—ã–π –∫–µ–π—Å",
                    price: 50,
                    color: "#808080",
                    image: "üì¶",
                    items: [
                        {name: "–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á", rarity: "common", emoji: "‚öîÔ∏è"},
                        {name: "–°—Ç–∞–ª—å–Ω–æ–π –º–µ—á", rarity: "rare", emoji: "üî™"},
                        {name: "–ê–º—É–ª–µ—Ç —Å–∏–ª—ã", rarity: "epic", emoji: "üîÆ"},
                        {name: "–≠–∫—Å–∫–∞–ª–∏–±—É—Ä", rarity: "legendary", emoji: "‚öúÔ∏è"}
                    ]
                },
                {
                    id: 2,
                    name: "üéÅ –ü—Ä–µ–º–∏—É–º –∫–µ–π—Å",
                    price: 100,
                    color: "#FFD700", 
                    image: "üéÅ",
                    items: [
                        {name: "–ó–æ–ª–æ—Ç–æ–π —â–∏—Ç", rarity: "rare", emoji: "üõ°Ô∏è"},
                        {name: "–û–≥–Ω–µ–Ω–Ω—ã–π –ø–æ—Å–æ—Ö", rarity: "epic", emoji: "üî•"},
                        {name: "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π —à–∞—Ä", rarity: "legendary", emoji: "üíé"}
                    ]
                }
            ];
            
            cases.forEach(caseItem => {
                const caseCard = document.createElement('div');
                caseCard.className = `case-card rarity-${caseItem.items[0].rarity}`;
                caseCard.style.borderColor = caseItem.color;
                caseCard.onclick = () => openCase(caseItem.id);
                
                caseCard.innerHTML = `
                    <div class="case-emoji">${caseItem.image}</div>
                    <h3>${caseItem.name}</h3>
                    <div class="case-price">${caseItem.price} –º–æ–Ω–µ—Ç</div>
                    <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                        ${caseItem.items.map(item => item.emoji).join(' ')}
                    </div>
                `;
                
                casesGrid.appendChild(caseCard);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
            const inventory = document.getElementById('inventory');
            inventory.innerHTML = '';
            
            if (!userData.inventory || userData.inventory.length === 0) {
                inventory.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>';
                return;
            }
            
            userData.inventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                
                itemElement.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-info">
                            <div style="font-weight: bold;">${item.name}</div>
                            <div style="font-size: 0.8em; opacity: 0.8;">${item.rarity}</div>
                        </div>
                    </div>
                    <div class="item-count">${item.count} —à—Ç.</div>
                `;
                
                inventory.appendChild(itemElement);
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É
        function showReward(item, newBalance, casePrice) {
            const modal = document.getElementById('rewardModal');
            const rarityColors = {
                'common': '#808080',
                'rare': '#0070dd', 
                'epic': '#a335ee',
                'legendary': '#ff8000'
            };
            
            document.getElementById('rewardEmoji').textContent = item.emoji;
            document.getElementById('rewardName').textContent = item.name;
            document.getElementById('rewardRarity').textContent = item.rarity;
            document.getElementById('rewardRarity').style.background = rarityColors[item.rarity];
            document.getElementById('newBalance').textContent = newBalance;
            
            modal.style.display = 'flex';
        }
        
        function closeReward() {
            document.getElementById('rewardModal').style.display = 'none';
            loadUserData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
        tg.onEvent('webAppDataReceived', (event) => {
            try {
                console.log('Received data from bot:', event);
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    showError(data.error);
                    loadUserData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    return;
                }
                
                if (data.balance !== undefined) {
                    // –≠—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    userData = data;
                    updateUI();
                } else if (data.success) {
                    // –≠—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
                    showReward(data.item, data.new_balance, data.case_price);
                }
            } catch (e) {
                console.error('Error parsing data:', e);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        });
        
        function showError(message) {
            const casesGrid = document.getElementById('casesGrid');
            casesGrid.innerHTML = `<div class="error">${message}</div>`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            const retryButton = document.createElement('button');
            retryButton.className = 'button';
            retryButton.textContent = '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
            retryButton.onclick = loadUserData;
            retryButton.style.marginTop = '10px';
            casesGrid.appendChild(retryButton);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadUserData();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            console.error('Global error:', e);
            showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');
        });
    </script>
</body>
</html>
